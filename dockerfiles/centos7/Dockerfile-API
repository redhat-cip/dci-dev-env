FROM centos:7

LABEL name="DCI API" version="0.0.2"
MAINTAINER DCI Team <distributed-ci@redhat.com>

RUN yum -y --setopt=tsflags=nodocs install epel-release \
    https://packages.distributed-ci.io/dci-release.el7.noarch.rpm \
    centos-release-openstack-ocata && \
    yum-config-manager --save --setopt=centos-openstack-ocata.exclude=python-zmq,zeromq && \
    yum -y --setopt=tsflags=nodocs install dci-api && \
    yum -y install python-jwt && \
    yum -y install httpd mod_wsgi && \
    yum clean all

WORKDIR /opt/dci-control-server
ENV PYTHONPATH /opt/dci-control-server
ENV DCI_SETTINGS_FILE /tmp/settings/settings.py

EXPOSE 5000

COPY utils/keycloak-provision.py /opt/keycloak-provision.py
COPY utils/dci_api_vhost.conf /etc/httpd/conf.d/dci_api.conf
COPY entrypoints/api.sh /entrypoint-api.sh
ENTRYPOINT ["/entrypoint-api.sh"]

CMD ["/usr/sbin/httpd", "-D", "FOREGROUND"]
